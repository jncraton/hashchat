<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>hashchat</title>
  </head>
  <body>
    <textarea rows="5" cols="50" placeholder="Enter your prompt"></textarea>
    <h2>Response:</h2>
    <pre id="response"></pre>

    <script>
      document.querySelector('textarea').value = location.hash.slice(1)

      document.querySelector('textarea').addEventListener('keydown', async e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault()
        } else {
          return
        }
        localStorage.geminiKey = localStorage.geminiKey || window.prompt('Gemini Key')

        const prompt = document.querySelector('textarea').value
        const responseElement = document.getElementById('response')

        if (!prompt) {
          alert('Please enter a prompt.')
          return
        }

        responseElement.textContent = ''

        const url =
          'https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:streamGenerateContent?alt=sse'

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': localStorage.geminiKey,
            },
            body: `{contents:[{parts:[{text:${JSON.stringify(prompt)}}]}]}`,
          })

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`)
          }

          const reader = response.body.getReader()
          const decoder = new TextDecoder()

          while (true) {
            const { done, value } = await reader.read()
            if (done) {
              break
            }
            const chunk = decoder.decode(value)
            const lines = chunk.split('\n')
            for (const line of lines) {
              if (line.startsWith('data:')) {
                const jsonString = line.substring(5).trim()
                if (jsonString) {
                  try {
                    const json = JSON.parse(jsonString)
                    if (json.candidates && json.candidates[0].content && json.candidates[0].content.parts[0]) {
                      responseElement.textContent += json.candidates[0].content.parts[0].text
                    }
                  } catch (e) {
                    console.error('Error parsing JSON:', e)
                  }
                }
              }
            }
          }
        } catch (error) {
          console.error('Error:', error)
          responseElement.textContent = `Error: ${error.message}`
        }
      })
    </script>
  </body>
</html>
