<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>hashchat</title>
    <style>
      :root {
        width: 600px;
        margin: 0 auto;
        font-family: sans serif;
        font-size: 16px;
      }

      * {
      }

      textarea {
        width: 100%;
        resize: none;
        font-size: 1rem;
      }

      pre {
        text-wrap: wrap;
      }
    </style>
  </head>
  <body>
    <textarea rows="5" placeholder="Enter your prompt"></textarea>
    <h2>Response <button id="copy">Copy ðŸ“‹</button></h2>
    <pre id="response"></pre>

    <script>
      const chat = async () => {
        localStorage.geminiKey = localStorage.geminiKey || window.prompt('Gemini Key')

        const prompt = document.querySelector('textarea').value
        const responseElement = document.getElementById('response')

        if (!prompt) {
          alert('Please enter a prompt.')
          return
        }

        responseElement.textContent = ''

        const url =
          'https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:streamGenerateContent?alt=sse'

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': localStorage.geminiKey,
            },
            body: `{contents:[{parts:[{text:${JSON.stringify(prompt)}}]}],"tools":[{"url_context":{}},{"code_execution": {}}]}`,
          })

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`)
          }

          const reader = response.body.getReader()
          const decoder = new TextDecoder()

          while (true) {
            const { done, value } = await reader.read()
            if (done) {
              break
            }
            const chunk = decoder.decode(value)
            const lines = chunk.split('\n')
            for (const line of lines) {
              if (line.startsWith('data:')) {
                const jsonString = line.substring(5).trim()
                if (jsonString) {
                  try {
                    const json = JSON.parse(jsonString)
                    if (json.candidates && json.candidates[0].content && json.candidates[0].content.parts[0]) {
                      const part = json.candidates[0].content.parts[0]
                      if (part.text) responseElement.textContent += part.text
                      if (part.executableCode)
                        responseElement.textContent += '\n\n## Executable Code\n\n' + part.executableCode.code
                      if (part.codeExecutionResult)
                        responseElement.textContent +=
                          '\n\n## Execution Result\n\n' + part.codeExecutionResult.output + '\n-----\n\n'
                    }
                  } catch (e) {
                    console.error('Error parsing JSON:', e)
                  }
                }
              }
            }
          }
        } catch (error) {
          console.error('Error:', error)
          responseElement.textContent = `Error: ${error.message}`
        }
      }

      if (location.hash.slice(1)) {
        document.querySelector('textarea').value = location.hash.slice(1)
        chat()
      }

      const copyResponse = async () => {
        await navigator.clipboard.writeText(response.textContent)
      }

      copy.addEventListener('click', copyResponse)

      document.addEventListener('keydown', function (ev) {
        if ((ev.key === 'c' || ev.key === 'C') && (ev.ctrlKey || ev.metaKey)) {
          copyResponse()
        }
      })

      document.querySelector('textarea').addEventListener('keydown', async e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault()
          chat()
        } else {
          return
        }
      })
    </script>
  </body>
</html>
