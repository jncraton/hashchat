<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>hashchat</title>
    <link rel="stylesheet" href="do.min.css" />
    <link rel="stylesheet" href="reveal.js/dist/reveal.css" />
    <link rel="stylesheet" href="reveal.js/dist/theme/serif.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.25/dist/katex.min.css"
      integrity="sha384-WcoG4HRXMzYzfCgiyfrySxx90XSl2rxY5mnVY5TwtWE6KLrArNKn0T/mOgNL0Mmi"
      crossorigin="anonymous" />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.25/dist/katex.min.js"
      integrity="sha384-J+9dG2KMoiR9hqcFao0IBLwxt6zpcyN68IgwzsCSkbreXUjmNVRhPFTssqdSGjwQ"
      crossorigin="anonymous"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.25/dist/contrib/auto-render.min.js"
      integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh"
      crossorigin="anonymous"></script>
    <style>
      :root {
        --w: 960px;
        --c: #522d72;
        --r-heading-color: var(--c);
        --r-background-color: #fff;
      }

      body {
        margin: 0;
      }

      body > * {
        padding-block: 0;
      }

      textarea {
        resize: none;
      }

      label:has(:checked) ~ *:nth-of-type(1) {
        display: none;
      }

      label:not(:has(:checked)) ~ *:nth-of-type(2) {
        display: none;
      }

      [for='raw'] {
        display: block;
        text-align: right;
        width: 100%;
      }

      .loader {
        width: 100%;
        height: 12px;
        display: inline-block;
        background-color: #fff;
        background-image: linear-gradient(
          45deg,
          rgba(0, 0, 0, 0.25) 25%,
          transparent 25%,
          transparent 50%,
          rgba(0, 0, 0, 0.25) 50%,
          rgba(0, 0, 0, 0.25) 75%,
          transparent 75%,
          transparent
        );
        font-size: 30px;
        background-size: 1em 1em;
        box-sizing: border-box;
        animation: barStripe 1s linear infinite;
      }

      @keyframes barStripe {
        0% {
          background-position: 1em 0;
        }
        100% {
          background-position: 0 0;
        }
      }
    </style>
    <script src="ugfm.min.js"></script>
    <link rel="icon" href="favicon.ico" />
  </head>
  <body>
    <header>
      <nav>
        <button id="clearBtn">üßπ&nbsp;Clear</button>
        <button id="copyBtn">üìã&nbsp;Copy</button>
        <button id="regenerateBtn">‚ôªÔ∏è&nbsp;Regenerate</button>
        <button id="reflectBtn">üí°&nbsp;Reflect</button>
        <button id="quizBtn">‚úèÔ∏è&nbsp;Quiz</button>
        <button id="presentBtn">üìΩÔ∏è&nbsp;Present</button>
      </nav>
    </header>
    <main>
      <label for="raw">Raw Output <input type="checkbox" id="raw" /></label>
      <article id="responseMarkdownElement"></article>
      <article><pre id="responseElement" contenteditable></pre></article>
    </main>
    <footer>
      <section>
        <label>Prompt<textarea id="userPrompt" rows="5" placeholder="Enter your prompt"></textarea></label>
        <details>
          <summary>Generation Config</summary>
          <label>
            Model
            <select id="model" autocomplete="off">
              <option value="gemini-pro-latest">Gemini Pro Latest</option>
              <option value="gemini-flash-latest" selected>Gemini Flash Latest</option>
              <option value="gemini-flash-lite-latest">Gemini Flash Lite Latest</option>
            </select>
          </label>
          <label>
            Temperature
            <input id="temperature" type="number" min="0" max="2" step=".1" value="0" />
          </label>
          <label>
            Thinking Budget
            <input id="thinking" type="range" min="0" max="32768" step="512" value="512" />
          </label>
          <label>
            System
            <textarea id="system" rows="5" autocomplete="off">
Never attempt to relate, empathize, or provide encouragement.

Never ask follow-up questions.

Never use "I", or the first person. Simply state facts, do not qualify them with "as an artificial intelligence" or similar.

Respond avoiding overly complex sentence structure.

Never use emojis unless explicitly requested. When requested, use unicode characters for emojis.

Never use **bold** or *italics*, even for headings and list items. Can use other markdown formatting including blockquotes and fenced code blocks as appropriate.

Favor basic ascii characters over smart quotes and similar fancy characters. Never use em dashes.

Always include links to Wikipedia on the first mention of key terms, ideas, and people.

Never nest lists by including a list within another list. Prefer headings. For example, don't do this:

1. a
    - b
        - c

Instead do this:

## a

### b

- c

Always bold dollar amounts: **$2**

Always being with an h1 (`# heading`) describing the topic.

{% if lecture or reflection %}
## Persona

Respond as a professional who specializes in high quality, engaging undergraduate education. This persona shapes responses, but should never be mentioned directly.

{% endif %}

{% if lecture %}
## Pedagogy

Include three or four discussion questions. There should be only one question per slide, and those slides should not have titles or headings.

Include two or three exercises that could be worked by students in the classroom in a few minutes. Always end with a small exercise. Each exercise should simply have the heading "## Exercise".

Do not wrap up with a generic "Questions?" or review slide.

Include exercises and discussion questions throughout the presentation. Do not put them all together.
{% endif %}

{% if reflection %}
Refection questions should focus on the upper levels of Bloom's revised taxonomy (apply, analyze, evaluate, and create) while having less focus on the lower levels (remember and understand).

Questions should be no more than 30 words. Appropriate responses should be no more than a paragraphs or two. The questions should encourage deep thought, but not require a long essay to properly respond.

If the provided context include code, reflection questions may include coding tasks, but some should still be natural language reflection without code.
{% endif %}

{% if choice or quiz %}
Produce multiple choice questions with four possible answers and two alternate distractors. The first answer should aways be the correct option. A variety of questions should be provided focusing different levels of Bloom's revised taxonomy (remember, understand, apply, analyze, evaluate, create).

Output format should look something like this for each question:

## What is a function in Python?

---

- A named sequence of statements performing a computation
- A value returned from a computation
- A file containing Python definitions
- A variable used to store data

### Alternate Distractors

- A template for objects
- A mechanism used to view backtraces

Questions should be no more than 30 words. Answers should be no more than 8 words.
{% endif %}

{% if revealjs or slides %}
## Formatting

The slides should be in markdown format that will be used to generate a reveal.js presentation using pandoc.

New slides are created using h2 `## title` to create a new slide. The title is required. `##` on a line alone is illegal. Horizontal rules `---` are used to create a new slide in place of `##` only on very short slides containing a single item. 

The first slide should use a level 1 heading and include no content other than the title. Other slides should use level 2 headings. The title should reflect the content of the presentation and never use the word "lecture" or "presnetation".

Slide titles should never be more than 3 words.

Favor many small slides over a few large slides. Never include more than 20 words on a slide.

If a list is used on a slide, do not end list item text with a period.

Properly fence any code examples on slides.

The deck should include 20 to 30 slides.

The entire response must only the slide deck. Do not include any introductory or concluding text.

## Example

```
# Title

## Slide 1 Title

- Some info
- More info

---

What do you think of that?

## Slide 2 Title

- Some info
- More info

## Exercise

Application exercise

## Slide 3 Title

- Some info
- More info

## Exercise

Synthesis exercise
```
{% endif %}
          </textarea
            >
          </label>
        </details>
      </section>
    </footer>
    <div class="reveal" style="display: none">
      <div class="slides"></div>
    </div>
    <script>
      async function encode(text) {
        let stream = new Blob([text]).stream()

        stream = stream.pipeThrough(new CompressionStream('deflate-raw'))
        const res = await new Response(stream)

        const blob = await res.blob()
        const buffer = await blob.arrayBuffer()

        return ';' + btoa(String.fromCharCode(...new Uint8Array(buffer)))
      }

      async function decode(text) {
        if (text[0] != ';') {
          console.error('Invalid encoding for text', text)
          return
        }
        text = text.slice(1)

        const binary = Uint8Array.from(atob(text), c => c.charCodeAt(0))

        let stream = new Blob([binary]).stream()

        stream = stream.pipeThrough(new DecompressionStream('deflate-raw'))

        const res = await new Response(stream)
        const blob = await res.blob()

        return await blob.text()
      }

      const clear = () => {
        responseMarkdownElement.innerHTML = ''
        responseElement.textContent = ''
        userPrompt.focus()
      }

      const chat = async () => {
        localStorage.geminiKey = localStorage.geminiKey || prompt('Gemini Key')

        if (!userPrompt.value) {
          alert('Please enter a prompt.')
          return
        }

        clear()
        responseMarkdownElement.innerHTML = '<span class="loader"></span>'

        let sysPrompt = system.value.trim()
        sysPrompt = sysPrompt.replace(/{% if (.*?) %}(.*?){% endif %}/gms, (_, condition, src) => {
          for (kw of condition.split(' or ')) {
            if (userPrompt.value.slice(0, 100).toLowerCase().includes(kw)) {
              console.log(`Including ${kw} in prompt`)
              return src
            }
          }
          return ''
        })

        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model.value}:streamGenerateContent?alt=sse`

        console.log(sysPrompt)

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': localStorage.geminiKey,
            },
            body: JSON.stringify({
              system_instruction: {
                parts: [
                  {
                    text: sysPrompt,
                  },
                ],
              },
              contents: [
                {
                  parts: [
                    {
                      text: userPrompt.value,
                    },
                  ],
                },
              ],
              tools: [
                {
                  url_context: {},
                },
              ],
              generationConfig: {
                thinkingConfig: {
                  thinkingBudget: thinking.value,
                },
                temperature: temperature.value,
              },
            }),
          })

          if (!response.ok) {
            if (response.status == '400' || response.status == '403') {
              responseMarkdownElement.innerHTML =
                '<h1>API Error</h1><h2>Bad Request</h2>Retry after providing new API key.'
              localStorage.geminiKey = ''
            } else {
              responseMarkdownElement.innerHTML = '<h1>API Error</h1>'
            }
            throw new Error(`HTTP error! status: ${response.status}`)
          }

          const reader = response.body.getReader()
          const decoder = new TextDecoder()

          while (true) {
            const { done, value } = await reader.read()
            if (done) {
              break
            }
            const chunk = decoder.decode(value)
            const lines = chunk.split('\n')
            for (const line of lines) {
              if (line.startsWith('data:')) {
                const jsonString = line.substring(5).trim()
                if (jsonString) {
                  try {
                    const json = JSON.parse(jsonString)
                    console.log(json)
                    if (json.candidates && json.candidates[0].content && json.candidates[0].content.parts[0]) {
                      const part = json.candidates[0].content.parts[0]
                      if (part.text) responseElement.textContent += part.text
                      if (part.executableCode)
                        responseElement.textContent += '\n\n## Executable Code\n\n' + part.executableCode.code
                      if (part.codeExecutionResult)
                        responseElement.textContent +=
                          '\n\n## Execution Result\n\n' + part.codeExecutionResult.output + '\n-----\n\n'

                      updateResponse(responseElement.textContent)
                      updateHash()
                    }
                  } catch (e) {
                    console.error('Error parsing JSON:', e)
                  }
                }
              }
            }
          }
        } catch (error) {
          console.error('Error:', error)
          responseElement.textContent = `Error: ${error.message}`
        }
      }

      const copyResponse = async () => {
        await navigator.clipboard.writeText(responseElement.textContent)
      }

      const present = () => {
        let deckHTML = responseMarkdownElement.innerHTML
        deckHTML = deckHTML.replaceAll('<h2>', '</section><section><h2>')
        deckHTML = deckHTML.replaceAll('<hr>', '</section><section>')
        deckHTML = `<section>${deckHTML}</section>`
        document.querySelector('.slides').innerHTML = deckHTML
        let deck = new Reveal({})
        deck.initialize()
        document.querySelectorAll('header,main,footer').forEach(e => (e.style.display = 'none'))
        document.querySelector('.reveal').style.display = 'block'
        document.styleSheets[0].disabled = true
        console.log('Slides initialized')
      }

      const reflect = () => {
        open(
          '#' +
            encodeURIComponent(
              `Generate 10 reflection questions based on the following:\n\n${responseElement.textContent}`,
            ),
          '_blank',
        )
      }

      const quiz = () => {
        open(
          '#' +
            encodeURIComponent(
              `Generate 10 multiple choice quiz questions based on the following:\n\n${responseElement.textContent}`,
            ),
          '_blank',
        )
      }

      clearBtn.addEventListener('click', clear)
      copyBtn.addEventListener('click', copyResponse)
      regenerateBtn.addEventListener('click', chat)
      presentBtn.addEventListener('click', present)
      reflectBtn.addEventListener('click', reflect)
      quizBtn.addEventListener('click', quiz)

      const updateHash = async () => {
        location.hash = await encode(JSON.stringify([userPrompt.value, responseElement.textContent]))
      }

      const updateResponse = response => {
        if (response) {
          responseElement.textContent = response

          responseMarkdownElement.innerHTML = ''
          responseMarkdownElement.append(...ugfm(response).childNodes)

          renderMathInElement(document.body, {
            delimiters: [
              { left: '$$', right: '$$', display: true },
              { left: '$', right: '$', display: false },
              { left: '\\(', right: '\\)', display: false },
              { left: '\\[', right: '\\]', display: true },
            ],
            throwOnError: false,
            ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'option', 'em', 'strong'],
          })
        }
      }

      responseElement.addEventListener('input', e => updateResponse(e.target.value))
      document.querySelector('#raw').addEventListener('click', _ => updateResponse(responseElement.textContent))

      addEventListener('keydown', function (e) {
        const isCtrl = e.ctrlKey || e.metaKey
        const key = e.key || String.fromCharCode(e.keyCode)

        if (isCtrl && e.key === 'F5') {
          e.preventDefault()
          present()
        }
      })

      document.addEventListener('keydown', function (ev) {
        if ((ev.key === 'c' || ev.key === 'C') && (ev.ctrlKey || ev.metaKey)) {
          copyResponse()
        }
      })

      document.querySelector('#userPrompt').addEventListener('keydown', async e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault()
          chat()
        } else {
          return
        }
      })

      async function init() {
        if (location.hash.slice(1)) {
          let prompt
          let response

          if (location.hash[1] == ';') {
            let hash = await decode(location.hash.slice(1))
            ;[prompt, response] = JSON.parse(hash)
          } else {
            ;[prompt, response] = location.hash.slice(1).split(';')

            prompt = decodeURIComponent(prompt)
            response = response ? decodeURIComponent(response) : null
          }

          userPrompt.value = prompt

          if (response) {
            updateResponse(response)
          } else {
            chat()
          }
        } else {
          userPrompt.focus()
        }
      }
      window.addEventListener('load', init)
    </script>
    <script src="reveal.js/dist/reveal.js"></script>
  </body>
</html>
